<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="数据库,分库分表,">










<meta name="description" content="前言国庆前这段时间一直都在搞分库分表相关的东西，中间遇到了比较多的问题，不过最后还是都艰难地解决掉了。这段时间感觉挺累但又挺有意思的，需要思考的点很多，所以决定写篇博客水总结一下。毕竟因为最近在刷算法题，没更新过什么博客了，趁国庆时间比较多，赶紧卷一卷。 背景先说一下背景吧。我们项目之前是完全没做分库分表的，现在有几张核心的表，数据量已经非常大了，数据量最大的一张表已经有接近250亿的数据了……我">
<meta name="keywords" content="数据库,分库分表">
<meta property="og:type" content="article">
<meta property="og:title" content="聊聊我最近的分库分表骚操作">
<meta property="og:url" content="http://yoursite.com/2021/10/03/聊聊我最近的分库分表骚操作/index.html">
<meta property="og:site_name" content="HandsomeDong七里翔">
<meta property="og:description" content="前言国庆前这段时间一直都在搞分库分表相关的东西，中间遇到了比较多的问题，不过最后还是都艰难地解决掉了。这段时间感觉挺累但又挺有意思的，需要思考的点很多，所以决定写篇博客水总结一下。毕竟因为最近在刷算法题，没更新过什么博客了，趁国庆时间比较多，赶紧卷一卷。 背景先说一下背景吧。我们项目之前是完全没做分库分表的，现在有几张核心的表，数据量已经非常大了，数据量最大的一张表已经有接近250亿的数据了……我">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://img-blog.csdnimg.cn/c2225430e10b4562bc25d966864039e9.jpg#pic_center">
<meta property="og:image" content="https://img-blog.csdnimg.cn/a4a50e6a14d64d889e6f9c42327635e3.png#pic_center">
<meta property="og:image" content="https://img-blog.csdnimg.cn/60b58989885642a2a029268729dfce20.gif#pic_center">
<meta property="og:image" content="https://img-blog.csdnimg.cn/2ccda90f6bbb4040845c37649d4e1bf4.jpg#pic_center">
<meta property="og:image" content="https://img-blog.csdnimg.cn/c8f044b7d9664254b89d6f775cac2b1c.gif#pic_center">
<meta property="og:image" content="https://img-blog.csdnimg.cn/6b855c47ef304083ac7fc508239f8912.png#pic_center">
<meta property="og:image" content="https://img-blog.csdnimg.cn/518f43b1fd8f4cc485b3112588ca4d20.png#pic_center">
<meta property="og:image" content="https://img-blog.csdnimg.cn/c780dae7556c4e0bb8396bef588323d3.jpg?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5LiD6YeM57-U,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center">
<meta property="og:image" content="https://img-blog.csdnimg.cn/aab14646598542eeaad907c1e0439300.jpg?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5LiD6YeM57-U,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center">
<meta property="og:image" content="https://img-blog.csdnimg.cn/21801bc2d7434ba58a98d81d9d9cc30f.jpg?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5LiD6YeM57-U,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center">
<meta property="og:image" content="https://img-blog.csdnimg.cn/ce063a80027f49f7abd70ba5fb6592b7.jpg?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5LiD6YeM57-U,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center">
<meta property="og:image" content="https://img-blog.csdnimg.cn/b8ee278f0d934eca934132b32bb878be.jpg?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5LiD6YeM57-U,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center">
<meta property="og:image" content="https://img-blog.csdnimg.cn/b59c7d9f72bf4cf0ad705e1899dee678.jpg?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5LiD6YeM57-U,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center">
<meta property="og:image" content="https://img-blog.csdnimg.cn/b668d4869b894181b2215c4c9fc14842.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5LiD6YeM57-U,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center">
<meta property="og:image" content="https://img-blog.csdnimg.cn/5eacb660f08944a9a652f7b82bda826a.gif#pic_center">
<meta property="og:image" content="https://img-blog.csdnimg.cn/696b08f5796f485e8e79a6927c252216.png#pic_center">
<meta property="og:image" content="https://img-blog.csdnimg.cn/6617a978bef2436e9c37020d4ce3f9f0.png#pic_center">
<meta property="og:image" content="https://img-blog.csdnimg.cn/1abd5ed41885470cba4a540d08e59405.jpg#pic_center">
<meta property="og:updated_time" content="2021-10-03T12:12:24.812Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="聊聊我最近的分库分表骚操作">
<meta name="twitter:description" content="前言国庆前这段时间一直都在搞分库分表相关的东西，中间遇到了比较多的问题，不过最后还是都艰难地解决掉了。这段时间感觉挺累但又挺有意思的，需要思考的点很多，所以决定写篇博客水总结一下。毕竟因为最近在刷算法题，没更新过什么博客了，趁国庆时间比较多，赶紧卷一卷。 背景先说一下背景吧。我们项目之前是完全没做分库分表的，现在有几张核心的表，数据量已经非常大了，数据量最大的一张表已经有接近250亿的数据了……我">
<meta name="twitter:image" content="https://img-blog.csdnimg.cn/c2225430e10b4562bc25d966864039e9.jpg#pic_center">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: false,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2021/10/03/聊聊我最近的分库分表骚操作/">





  <title>聊聊我最近的分库分表骚操作 | HandsomeDong七里翔</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">HandsomeDong七里翔</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/10/03/聊聊我最近的分库分表骚操作/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HandsomeDong七里翔">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HandsomeDong七里翔">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">聊聊我最近的分库分表骚操作</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-10-03T20:11:07+08:00">
                2021-10-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>国庆前这段时间一直都在搞分库分表相关的东西，中间遇到了比较多的问题，不过最后还是都艰难地解决掉了。这段时间感觉挺累但又挺有意思的，需要思考的点很多，所以决定写篇博客<del>水</del>总结一下。毕竟因为最近在刷算法题，没更新过什么博客了，趁国庆时间比较多，赶紧卷一卷。<br><img src="https://img-blog.csdnimg.cn/c2225430e10b4562bc25d966864039e9.jpg#pic_center" alt="水一篇博客"></p>
<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>先说一下背景吧。我们项目之前是完全没做分库分表的，现在有几张核心的表，数据量已经非常大了，数据量最大的一张表已经有接近250亿的数据了……我刚开始看到这张表的数据量是比较惊讶的，而且还跟DBA大佬了解了一下，现在线上这张表的操作耗时非常短，暂时没有性能问题。一般来说，千万级的数据量应该已经比较影响性能了，现在这个表已经差不多250亿数据了，还不出问题？<br><img src="https://img-blog.csdnimg.cn/a4a50e6a14d64d889e6f9c42327635e3.png#pic_center" alt="？"></p>
<p>我分析了一下这张表的结构，然后看了一下相关的SQL，我认为这张表暂时还没有性能问题有以下两点：</p>
<ol>
<li>数据结构简单。这是一张文件表，里面的字段不多，只有主键id、文件名、key、hash、url、大小等字段，占用的空间也不大</li>
<li>SQL不复杂。我分析了一下与这张表有关系的所有SQL，发现这张表几乎没有update操作（有是有，但是只有一个SQL，而且那个方法还被废弃了，我们现在的业务基本上不会对这张表的数据进行修改），只有insert和select操作，而且select操作大部分都是通过主键id作为条件查询，少量是通过hash字段来进行查询，所以需要维护的索引也不多，只有主键索引和这个hash字段的普通索引。所以这张表的相关SQL是比较简单的。</li>
</ol>
<p>虽然现在没有性能问题，但是嘛……现在这张表每个月的增长速度是亿级别的，再不做分库分表，迟早要出问题。所以我决定先对它出手了！另外几张表的数据量也很大，但是与之相关的操作太复杂了，所以我觉得我得先找个简单的表实践实践，积累一点经验后再对其它几张表下手。<br><img src="https://img-blog.csdnimg.cn/60b58989885642a2a029268729dfce20.gif#pic_center" alt="在这里插入图片描述"></p>
<h1 id="分库分表方案"><a href="#分库分表方案" class="headerlink" title="分库分表方案"></a>分库分表方案</h1><p>分库分表主要有垂直切分和水平水平，这次针对的问题是单表容量达到瓶颈的问题，因此采用<strong>水平切分</strong>。</p>
<p><strong>以下把这张表叫做 t_file 表吧。</strong></p>
<h2 id="切分策略"><a href="#切分策略" class="headerlink" title="切分策略"></a>切分策略</h2><p>水平切分策略主要有hash切分和范围切分，优缺点如下表。<br>| 切分策略 | 实现 | 优点 | 缺点 |<br>|–|–|–|–|<br>| hash切分 | hash取模mod | 数据分片相对比较均匀，不容易出现热点和并发访问的瓶颈 | 1.后期分片集群扩容需要迁移旧的数据。<br> 2.容易面临跨分片查询的复杂问题<br>| 范围切分 | 按照时间区间或ID区间来切分 | 1.单表大小可控<br>2.便于水平扩展<br>3.对范围查找友好 | 热点可能容易成为性能瓶颈 |</p>
<p><strong>最终经过考虑，决定采用范围切分策略</strong>，主要原因是 t_file 的主键原来是整型的自增主键，不适合用hash切分。目前数据量非常大，并且还涉及到另外几张表，有些表存储了一个列表，列表里存的就是整型ID，那些表也非常大，改的话影响范围太大，所以不可能把整型修改成其它类型。</p>
<h2 id="不分库，只分表"><a href="#不分库，只分表" class="headerlink" title="不分库，只分表"></a>不分库，只分表</h2><p>这张表我们有没有必要分库呢？我和我的mentor讨论了一下，觉得是暂时只做分表即可。只要原因有以下几个：</p>
<ol>
<li>我们有主从，做了读写分离（也不算完全读写分离，个别对延时方面要求高的SQL读的是主库），并且跟DBA大佬讨论过，数据库压力并没有那么大。而且我们如果在主从上又做分库，那每个实例启动后都需要连接并且管理大量的数据源，需要消耗大量资源，不是很值得</li>
<li>这张表，是存在一个独立的库中的，那个库只有这一张表！由于这张表数据里较大，之前我们就把这张表分出来放到一个独立的库中了，它跟其它表并不是在同一个数据库。所以它压力更小了</li>
<li>由于是水平切分，我们后期要是再想做分库的话，不用再次迁移数据，或者说迁移数据的复杂度很低，并且路由规则也不需要改太多。以后我们想做分库再做就是了，现在不用一步到位</li>
</ol>
<p><strong>所以最终决定不分库，只分表。</strong></p>
<h1 id="技术选型"><a href="#技术选型" class="headerlink" title="技术选型"></a>技术选型</h1><p>目前比较主流的分库分表中间件有mycat、sharding-jdbc、tidb，最终决定使用sharding-jdbc，原因有下：</p>
<ol>
<li>现在只打算分表，而不分库，Mycat和tidb并没有太大优势</li>
<li>mycat是proxy层解决方案，需要部署、维护，并且本身是单点的，高可用性差，如果想要集群还需要再引入别的中间件</li>
<li>tidb资源利用率低、维护成本也很高</li>
</ol>
<p><strong>综合业务及中间件优缺点考虑，sharding-jdbc较为合适。</strong><br><img src="https://img-blog.csdnimg.cn/2ccda90f6bbb4040845c37649d4e1bf4.jpg#pic_center" alt="就用sharding-jdbc"></p>
<h1 id="问题及解决方案"><a href="#问题及解决方案" class="headerlink" title="问题及解决方案"></a>问题及解决方案</h1><p>写的过程碰到了几个问题，搞了点骚操作。<br><img src="https://img-blog.csdnimg.cn/c8f044b7d9664254b89d6f775cac2b1c.gif#pic_center" alt="满脑子骚操作"></p>
<h2 id="分布式ID实现"><a href="#分布式ID实现" class="headerlink" title="分布式ID实现"></a>分布式ID实现</h2><h3 id="不重复的ID该怎么实现？"><a href="#不重复的ID该怎么实现？" class="headerlink" title="不重复的ID该怎么实现？"></a>不重复的ID该怎么实现？</h3><p><strong>分库分表后，需要保证数据插入后ID的唯一性</strong>，实现不重复的ID一般有以下几种方案：</p>
<ol>
<li>使用雪花算法生成ID。雪花算法会生成64 bit的ID，转成字符串后长度是19位（有个表需要存储文件表数据ID），长度比较长。如果我们使用了雪花算法，那另一个表每一行的数据都会膨胀很多，这就不是很划算了……</li>
<li>实现发号器。可通过redis的incrby实现全局单调ID生成器，从而保证唯一性。但是这个方案会使插入数据操作强依赖于中间件，必须考虑到持久化、高可用等问题，实现一个靠谱的发号器需要考虑到的地方太多，不容易落地。</li>
<li>使用UUID。我们要用整型ID，UUID没法满足。</li>
<li><strong>使用数据库的自增ID</strong>。该表的数据比较特殊，只会新增，不会删除，并且极少有修改操作，因此可以考虑继续使用数据库的自增ID。而要保证每个表的ID都不重复，那就要先确定好每个表的ID范围没有交集，再在建表时设置好表的起始自增序列号，业务方需要确保在插入数据时判断该表的最大ID必须小于下一个表的起始自增序列号。例如我们打算每个表存储100行数据，那么 t_file_0 表的ID范围为 0 ~ 99（当然，我们没有ID为0的数据，最小的是1），t_file_1 表的ID范围为 100 ~ 199 ，t_file_2 表的ID范围为 200 ~ 299……</li>
</ol>
<p><strong>方案四实现全局唯一ID比较简单，类型符合我们要求，性能也没有损耗，因此决定采用方案四。但是问题接踵而至。</strong></p>
<p>使用方案四，就会有三个问题：</p>
<ol>
<li>建表前需要确认好每个表的ID范围，建表时设置好起始自增序列号</li>
<li><strong>在插入ID时维护好当前要插入的数据对应的表下标</strong>，根据上面的例子，当 t_file 里的数据最大ID为99时，后面的数据不能再插入到该表中，而是要插入到 t_file_1 中，这意味着我们需要维护一个当前数据对应的表下标，即“我需要知道现在的数据需要插入到哪个表”</li>
<li>使用自己的策略就意味着不能使用sharding-jdbc的ID生成策略了</li>
</ol>
<p>第一个问题只需运维或者后端开发建表前注意一下即可，而第二个问题则需要在代码中解决，而第三个问题，只需要我们把表下标传进mapper，交给mybatis帮我们拼装到SQL里面即可。</p>
<p><strong>所以现在主要是要解决第二个问题。</strong><br><img src="https://img-blog.csdnimg.cn/6b855c47ef304083ac7fc508239f8912.png#pic_center" alt="愁"></p>
<h2 id="表下标维护"><a href="#表下标维护" class="headerlink" title="表下标维护"></a>表下标维护</h2><p>那么要怎么维护这个表下标呢？我当时是思考了一个下午，一步步优化，得到一个自认为不错的方案（太佩服我自己了吧），而且实现也不复杂。<strong>这个方案就是每个表预留一部分ID，然后每个实例各自维护一个表下标，不存储在redis中。</strong></p>
<p>下面来看看整个优化的过程。<br><img src="https://img-blog.csdnimg.cn/518f43b1fd8f4cc485b3112588ca4d20.png#pic_center" alt="我真是个天才"></p>
<h3 id="插入前查询maxId"><a href="#插入前查询maxId" class="headerlink" title="插入前查询maxId"></a>插入前查询maxId</h3><p>最直接的写法就是每次批量插入数据前，先查询表的最大ID，再加上当前的数据量，预测插入数据后的ID是否还在范围内，若超过了该范围，就把下标+1，更新到redis中，然后把数据插入到下一个表中。<br><img src="https://img-blog.csdnimg.cn/c780dae7556c4e0bb8396bef588323d3.jpg?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5LiD6YeM57-U,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="插入前查询maxId"></p>
<p>单线程下这种做法当然没有问题，但是多线程问题就大了，何况这个业务并发量还那么高。</p>
<p>假设 t_file_0 的ID范围是0 ~ 9999，现在该表最大的ID是9995，此时2个线程同时插入数据，这2个线程都插入4行数据……2个线程获取到的tableIndex都是0，并且查了一下maxId加上自己的数据量，最后得到9999，在范围内，然后同时插入数据……那么 t_file_0 这个表就会出现ID超过了9999的情况，而 t_file_1 的ID范围是 10000~19999，ID重复了！</p>
<p>所以很明显，<strong>这个方案不靠谱。</strong></p>
<h3 id="插入后查询maxId"><a href="#插入后查询maxId" class="headerlink" title="插入后查询maxId"></a>插入后查询maxId</h3><p>既然插入后的ID可能会超出范围，那我们能不能在插入后再检查一下maxId呢？如果maxId超出范围，就回滚事务，再更新tableIndex，把数据插入到下一张表中。<br><img src="https://img-blog.csdnimg.cn/aab14646598542eeaad907c1e0439300.jpg?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5LiD6YeM57-U,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="插入后查询maxId"><br>这种做法比较靠谱，插入后再检查ID，再决定是否提交事务，就不会出现最大ID超过该表范围这种情况了。<strong>但是却要手动控制事务。</strong></p>
<h3 id="预留ID"><a href="#预留ID" class="headerlink" title="预留ID"></a>预留ID</h3><p>那能不能再优化一下呢？我不想控制事务回滚然后再提交一次……</p>
<p>所以我想到了预留最后一部分ID的做法，<strong>我可以让每张表都预留一部分ID，这部分ID可以插入一部分数据，但是插入之后，以后的数据就插入到下一张表。只要我们预留的ID范围足够大，那在高并发场景下就不会出现ID超范围的情况。</strong></p>
<p>比如 t_file_0 的预留ID范围是 9000~9999，当插入一批数据后得到的最大ID是9100，达到了预留ID范围，那就更新表下标，以后的数据插入到 t_file_1 中。即使多个线程同时插入一大批数据，只要我们预留的范围足够大，就不会出现最大ID超过这张表范围的情况。这样就不用手动控制事务了。<br>而我们需要查询的时候，ID为 0 ~ 9999（包括预留的那部分ID，9000 ~ 9999） 还是路由到 t_file_0 进行查询，所以插入和查询都是不会有问题的。</p>
<p><img src="https://img-blog.csdnimg.cn/21801bc2d7434ba58a98d81d9d9cc30f.jpg?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5LiD6YeM57-U,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="预留ID"><br>但是这样又依赖与中间件了，这样的话，redis一出问题，那可能就会影响到当前业务的新增操作了。</p>
<h3 id="预留ID-不依赖redis"><a href="#预留ID-不依赖redis" class="headerlink" title="预留ID + 不依赖redis"></a>预留ID + 不依赖redis</h3><p>上面的方案，都是在redis维护了一个表下标。这样的话，redis一出问题，那可能就会影响到当前业务的新增操作了，但是<strong>实际上表下标是不需要在redis中再维护一份的，我只需要在每个实例中维护自己的一个下标就行了！</strong></p>
<p>这样的话，会有这个问题：当其中一个实例插入数据后，发现自己的下标要+1了，其它的实例无法感知到。</p>
<p><strong>但是这个问题并不会使ID重复，因为只要我预留的ID足够大，保证其它实例再插入数据的时候，不会超过当前表的最大ID，就不会出现问题！并且我们插入数据是分批插入的，每批最多100个数据</strong>。比如要插入1000个数据，我会分成10批数据，每批数据插入完成后都会检查一下maxId并更新表。所以理论上，只要满足这个条件，就绝对不会有重复ID的问题发生（<strong>当然我是测过的，你完全可以相信七里翔</strong>）： </p>
<blockquote>
<p><strong>预留ID数 &gt; 实例数 <em> 每个实例的最大线程数 </em> 100</strong></p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/ce063a80027f49f7abd70ba5fb6592b7.jpg?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5LiD6YeM57-U,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="预留ID + 不依赖redis"></p>
<h2 id="多数据源、sharding-jdbc、主从怎么结合到一块？"><a href="#多数据源、sharding-jdbc、主从怎么结合到一块？" class="headerlink" title="多数据源、sharding-jdbc、主从怎么结合到一块？"></a>多数据源、sharding-jdbc、主从怎么结合到一块？</h2><p>使用sharding-jdbc的shardingsphere，我又遇到了以下两个问题：</p>
<ol>
<li>在项目中使用了我们自己写的一个多数据源的组件，与shardingsphere数据源冲突</li>
<li>我们的分表+主从数据库架构不适合用shardingsphere</li>
</ol>
<p>针对这两个问题，我决定优化多数据源组件，整合shardingsphere。</p>
<h3 id="怎么解决多数据源和shardingsphere数据源冲突的问题？"><a href="#怎么解决多数据源和shardingsphere数据源冲突的问题？" class="headerlink" title="怎么解决多数据源和shardingsphere数据源冲突的问题？"></a>怎么解决多数据源和shardingsphere数据源冲突的问题？</h3><p>我们的项目中要到了一个自己开发多数据源组件，把这个多数据源组件的DataSource注到mybatis中，可以通过注解动态切换数据源。但是现在用shardingsphere，会跟这个组件起冲突。</p>
<p>看了一天源码后，我最后决定把shardingsphere集成到我们的多数据源组件中。我先在shardingsphere基础上写个自动配置类，封装多个shardingsphere的datasource，然后交给多数据源去管理。也就是，数据源组件只需要负责帮我切换数据源到shardingsphere，剩下的分片、路由相关的操作还是交给shardingsphere本身去完成。完美解决二者冲突的问题！</p>
<h3 id="怎么解决分表-主从数据库不适合用shardingsphere的问题？"><a href="#怎么解决分表-主从数据库不适合用shardingsphere的问题？" class="headerlink" title="怎么解决分表+主从数据库不适合用shardingsphere的问题？"></a>怎么解决分表+主从数据库不适合用shardingsphere的问题？</h3><p>我们的数据库是主从，现在使用shardingsphere来管理 t_file 表的路由，想要切换到从库数据源，只有两个办法：</p>
<ol>
<li>使用Hint分片策略，强制切换数据源。这种办法不靠谱，每次使用前都需要路由到指定的具体库和表，将产生大量重复的业务代码</li>
<li>配置shardingsphere的读写分离。这种方法也不靠谱，我们不一定所有的读都走从库，再加上我们有个别sql查询是不走shardingsphere的，这意味着这部分查询语句没法使用shardingsphere的读写分离。</li>
</ol>
<p>这两种方法都没法满足我们的业务需求，最终我决定再优化多数据源组件，使用多数据源管理多个shardingsphere DataSource。<br>通过配置多个shardingsphere数据源，把主数据库和从数据库配置到不同的shardingsphere数据源中，再注入到多数据源组件中，通过注解切换到不同的shardingsphere数据源，即可实现主从库数据源的切换，同时还能使用shardingsphere的功能，主从数据源共用同一套表路由算法，并且方便以后其它表使用shardingsphere来进行表路由。<br><img src="https://img-blog.csdnimg.cn/b8ee278f0d934eca934132b32bb878be.jpg?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5LiD6YeM57-U,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="dynamic-datasource和shardingsphere结合"></p>
<h1 id="影响"><a href="#影响" class="headerlink" title="影响"></a>影响</h1><h2 id="部分SQL性能问题"><a href="#部分SQL性能问题" class="headerlink" title="部分SQL性能问题"></a>部分SQL性能问题</h2><p>虽然这个表涉及的SQL不多，并且不复杂，但是还是有个别SQL可能会出现问题。<br>比如刚才说到的，通过hash查询某一行数据。有2个SQL，分别是这样：需要通过hash匹配查询第一行数据；需要通过hash匹配查询最后一行数据。<br>这2个SQL肯定不能走shardingsphere来查询的了，因为我的分片键只有id，这种查询条件不是分片键的SQL，会在所有的表中执行一次，最后在汇合处理，这样的效率肯定是非常低的。<br>还好这2个SQL也不复杂，我最后自己优化了一下。不通过shardingsphere去做路由，而是我自己传入表下标。比如需要通过hash匹配查询第一行数据，我传下标0进去执行SQL，数据为空，下标+1再查下一个表。直到查询到一行数据或者下标超出了当前插入数据的表下标（tableIndex）为止。</p>
<h1 id="上线前准备"><a href="#上线前准备" class="headerlink" title="上线前准备"></a>上线前准备</h1><h2 id="数据迁移"><a href="#数据迁移" class="headerlink" title="数据迁移"></a>数据迁移</h2><p>上线前需要运维协助建表并迁移数据，分表后每张表数据量为20亿，预留10万个ID。<br><img src="https://img-blog.csdnimg.cn/b59c7d9f72bf4cf0ad705e1899dee678.jpg?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5LiD6YeM57-U,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="数据迁移"></p>
<h2 id="服务切换"><a href="#服务切换" class="headerlink" title="服务切换"></a>服务切换</h2><p>服务更新与服务回滚是比较重要的环节，这个得要提前规划好。考虑好怎么样才能将服务切换时的影响降到最低。我刚开始的方案是，预留一部分主键ID，具体方案如下。</p>
<h3 id="预留一部分主键ID"><a href="#预留一部分主键ID" class="headerlink" title="预留一部分主键ID"></a>预留一部分主键ID</h3><p>采取预留一部分主键ID的方案让新旧服务能同时运行而不会产生主键冲突。</p>
<p>假如现在线上有250亿数据，按照每张表20亿数据分表，则可以分为13张表，下标为 0 ~ 12 ，t_file_12 的主键范围是 240亿~260亿-1，全量同步后开启增量同步，把后续新增的数据也同步过去。</p>
<p>假设增量的数据有1亿，那么增量同步差不多完成后，t_file_12 中的最大主键大概是251亿，还有9亿的ID可用。</p>
<p>这个时候新服务上线，新服务新增的数据插入到 t_file_13 中，而 t_file_13 的起始自增序列号为260亿，所以新旧服务一起运行时，一定时间内并不会出现主键冲突的情况。因此新服务上线后可以开启双向同步，观察新服务上线后的情况，确认完全没有问题后再关闭旧服务、双向同步。</p>
<p>整个过程的步骤为：</p>
<ol>
<li>在新库中新建课件文件表</li>
<li>全量同步</li>
<li>增量同步追加数据</li>
<li>开启双向同步</li>
<li>上线新服务</li>
<li>新服务无异常，关掉旧服务和双向同步</li>
</ol>
<p><img src="https://img-blog.csdnimg.cn/b668d4869b894181b2215c4c9fc14842.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5LiD6YeM57-U,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="预留一部分主键ID"><br>当我说完这个方案后，我自信满满，此时我的表情是这样的👇。<br><img src="https://img-blog.csdnimg.cn/5eacb660f08944a9a652f7b82bda826a.gif#pic_center" alt="自信满满"><br>但是，DBA大佬的表情先是这样的👇。<br><img src="https://img-blog.csdnimg.cn/696b08f5796f485e8e79a6927c252216.png#pic_center" alt="?"><br>然后，变成了这样👇。<br><img src="https://img-blog.csdnimg.cn/6617a978bef2436e9c37020d4ce3f9f0.png#pic_center" alt="!"><br>我内心慌了起来。</p>
<p>DBA大佬说：小伙子，这个上线方案不行。假如一个表原本的当前的自增序列号是10，而你插入了一行数据，这行数据里面包含了ID（即不是使用自增ID）的话，是会更新自增序列号的，比如你插入了一个ID为15的数据，那这个时候表的自增序列号就会变成16，而不是原来的10了。</p>
<p>我……<br><img src="https://img-blog.csdnimg.cn/1abd5ed41885470cba4a540d08e59405.jpg#pic_center" alt="是我太菜"></p>
<h3 id="最后的方案"><a href="#最后的方案" class="headerlink" title="最后的方案"></a>最后的方案</h3><p>还是DBA大佬经验丰富，和他讨论过后，我豁然开朗。最终的上线步骤是这样的。</p>
<ol>
<li>运维开启全量同步，把旧库数据同步到新库中</li>
<li>上线新服务（版本1），双写，先旧后新，数据全部从旧库读取。新库中的ID需和旧库中保持一致</li>
<li>下线旧服务，新旧服务同时运行的过程中旧服务产生的增量数据由运维处理，补到新库中</li>
<li>上线新服务（版本2），双写，先旧后新，数据全部从新库中读取</li>
<li>上线新服务（版本3），双写，先新后旧，数据全部从新库中读取。旧库的ID需和新库保持一致</li>
<li>新服务在线上运行一段时间没出现问题后，再更新代码上线新服务（版本4），去除双写机制，只需在新库中读写数据，旧库废弃</li>
</ol>
<h1 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h1><h2 id="存储过程"><a href="#存储过程" class="headerlink" title="存储过程"></a>存储过程</h2><p>新建表的时候的存储过程如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> create_tables()</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> @<span class="keyword">str</span> = <span class="string">"(</span></span><br><span class="line"><span class="string">  `c_id` bigint unsigned NOT NULL AUTO_INCREMENT,</span></span><br><span class="line"><span class="string">  `c_create_time` datetime NOT NULL,</span></span><br><span class="line"><span class="string">  `c_modify_time` datetime NOT NULL,</span></span><br><span class="line"><span class="string">  PRIMARY KEY (`c_id`),</span></span><br><span class="line"><span class="string">  KEY `idx_c_hash` (`c_hash`) USING BTREE,</span></span><br><span class="line"><span class="string">  KEY `idx_name` (`c_name`)</span></span><br><span class="line"><span class="string">) ENGINE=InnoDB AUTO_INCREMENT="</span>;</span><br><span class="line"><span class="keyword">set</span> @j = <span class="number">0</span>;</span><br><span class="line">while @j &lt; 100 do</span><br><span class="line"><span class="keyword">set</span> @auto_increment = @j * <span class="number">2000000000</span>;</span><br><span class="line"><span class="keyword">set</span> @<span class="keyword">table</span> = <span class="keyword">concat</span>(<span class="string">'t_file_'</span>,@j);</span><br><span class="line"><span class="keyword">set</span> @<span class="keyword">end</span> = <span class="string">" DEFAULT CHARSET=utf8"</span>;</span><br><span class="line"><span class="keyword">set</span> @sql_t = <span class="keyword">concat</span>(<span class="string">"CREATE TABLE "</span>,@<span class="keyword">table</span>, @<span class="keyword">str</span>, @auto_increment, @<span class="keyword">end</span>);</span><br><span class="line"><span class="keyword">prepare</span> sql_t <span class="keyword">from</span> @sql_t;</span><br><span class="line"><span class="keyword">execute</span> sql_t;</span><br><span class="line"><span class="keyword">set</span> @j = @j + <span class="number">1</span>;</span><br><span class="line"><span class="keyword">end</span> <span class="keyword">while</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">call</span> create_tables();</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">procedure</span> create_tables;</span><br></pre></td></tr></table></figure>
<h2 id="多数据源组件"><a href="#多数据源组件" class="headerlink" title="多数据源组件"></a>多数据源组件</h2><p><strong>我感觉这个多数据源组件有点意思。所以我在国庆这两天自己也写了个多数据源组件，并且集成了shardingsphere。感兴趣的可以点我头像，里面有我<a href="https://github.com/HandsomeDong" target="_blank" rel="noopener">github主页链接</a>，里面一个名为 dynamic-datasource-spring-boot-starter 的仓库就是这个项目了。</strong></p>
<h1 id="后续思考"><a href="#后续思考" class="headerlink" title="后续思考"></a>后续思考</h1><h2 id="假如要分库"><a href="#假如要分库" class="headerlink" title="假如要分库"></a>假如要分库</h2><p>现在是只做分表的情况，我可以把表下标传进去给mybatis拼到SQL里面。但是如果做了分库后要怎么办呢？</p>
<p>这个我也考虑到了，假如要做分库的话，那数据库的路由就需要交给sharingsphere去完成了，我能想到的是：用shardingsphere的hint强制路由策略，然后自己实现自定义注解，并且实现相应的路由策略，按理说是可以满足分库的需求的。</p>
<p>不过嘛，没实践过怎么会知道有没有其它问题呢？等有空了我再实现试试。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/数据库/" rel="tag"># 数据库</a>
          
            <a href="/tags/分库分表/" rel="tag"># 分库分表</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/07/02/SpringBoot-Dubbo简单demo实践/" rel="next" title="SpringBoot+Dubbo简单demo实践">
                <i class="fa fa-chevron-left"></i> SpringBoot+Dubbo简单demo实践
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="HandsomeDong七里翔">
            
              <p class="site-author-name" itemprop="name">HandsomeDong七里翔</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">22</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">12</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">tags</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#背景"><span class="nav-number">2.</span> <span class="nav-text">背景</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#分库分表方案"><span class="nav-number">3.</span> <span class="nav-text">分库分表方案</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#切分策略"><span class="nav-number">3.1.</span> <span class="nav-text">切分策略</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#不分库，只分表"><span class="nav-number">3.2.</span> <span class="nav-text">不分库，只分表</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#技术选型"><span class="nav-number">4.</span> <span class="nav-text">技术选型</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#问题及解决方案"><span class="nav-number">5.</span> <span class="nav-text">问题及解决方案</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#分布式ID实现"><span class="nav-number">5.1.</span> <span class="nav-text">分布式ID实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#不重复的ID该怎么实现？"><span class="nav-number">5.1.1.</span> <span class="nav-text">不重复的ID该怎么实现？</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#表下标维护"><span class="nav-number">5.2.</span> <span class="nav-text">表下标维护</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#插入前查询maxId"><span class="nav-number">5.2.1.</span> <span class="nav-text">插入前查询maxId</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#插入后查询maxId"><span class="nav-number">5.2.2.</span> <span class="nav-text">插入后查询maxId</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#预留ID"><span class="nav-number">5.2.3.</span> <span class="nav-text">预留ID</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#预留ID-不依赖redis"><span class="nav-number">5.2.4.</span> <span class="nav-text">预留ID + 不依赖redis</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#多数据源、sharding-jdbc、主从怎么结合到一块？"><span class="nav-number">5.3.</span> <span class="nav-text">多数据源、sharding-jdbc、主从怎么结合到一块？</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#怎么解决多数据源和shardingsphere数据源冲突的问题？"><span class="nav-number">5.3.1.</span> <span class="nav-text">怎么解决多数据源和shardingsphere数据源冲突的问题？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#怎么解决分表-主从数据库不适合用shardingsphere的问题？"><span class="nav-number">5.3.2.</span> <span class="nav-text">怎么解决分表+主从数据库不适合用shardingsphere的问题？</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#影响"><span class="nav-number">6.</span> <span class="nav-text">影响</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#部分SQL性能问题"><span class="nav-number">6.1.</span> <span class="nav-text">部分SQL性能问题</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#上线前准备"><span class="nav-number">7.</span> <span class="nav-text">上线前准备</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#数据迁移"><span class="nav-number">7.1.</span> <span class="nav-text">数据迁移</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#服务切换"><span class="nav-number">7.2.</span> <span class="nav-text">服务切换</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#预留一部分主键ID"><span class="nav-number">7.2.1.</span> <span class="nav-text">预留一部分主键ID</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#最后的方案"><span class="nav-number">7.2.2.</span> <span class="nav-text">最后的方案</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#其它"><span class="nav-number">8.</span> <span class="nav-text">其它</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#存储过程"><span class="nav-number">8.1.</span> <span class="nav-text">存储过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#多数据源组件"><span class="nav-number">8.2.</span> <span class="nav-text">多数据源组件</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#后续思考"><span class="nav-number">9.</span> <span class="nav-text">后续思考</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#假如要分库"><span class="nav-number">9.1.</span> <span class="nav-text">假如要分库</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">HandsomeDong七里翔</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  

  

  

<script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
</body>
</html>
